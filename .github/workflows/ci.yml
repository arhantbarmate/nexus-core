# Copyright 2026 Nexus Protocol Authors
# Continuous Integration - Phase 1.3.1
# Goal: Force deterministic quality gates for both Brain and Body layers.

name: Nexus Protocol Phase 1.3.1 CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  brain_integrity:
    name: Audit Nexus Brain (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Core requirements for import validation
          pip install fastapi uvicorn pydantic python-dotenv

      - name: Brain Static Analysis & Import Check
        run: |
          # Logic: Explicitly verifies that the Brain can boot and find its anchored paths
          python - <<EOF
          try:
              import backend.main
              print("ðŸ›ï¸ Brain Import & Path Anchoring Verified")
          except Exception as e:
              print(f"âŒ Brain Critical Failure: {e}")
              exit(1)
          EOF

  body_integrity:
    name: Build Nexus Body (Flutter Web)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter (Synchronized 3.38.6)
        uses: subosito/flutter-action@v2
        with:
          # SYNCHRONIZED: Matching 3.38.6 to prevent environment drift
          flutter-version: '3.38.6'
          channel: 'stable'
          cache: true

      - name: Install Body Dependencies
        run: |
          cd client
          flutter pub get

      - name: Static Analysis
        run: |
          cd client
          # Logic: Fails the build if "Red Line" bridge errors are detected
          flutter analyze || exit 1

      - name: Build Web Surface (Stress Test)
        run: |
          cd client
          # --no-tree-shake-icons: Hardening for custom font rendering in Phase 1.3.1
          flutter build web --release --dart-define=NEXUS_DEV=true --no-tree-shake-icons