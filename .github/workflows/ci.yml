# Copyright 2026 Coreframe Systems
# Continuous Integration - Phase 1.4.0 (Hardened Ingress)
# Goal: Enforce deterministic quality gates for Sovereign Edge deployment.

name: Nexus Protocol CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  brain_integrity:
    name: Audit Nexus Brain (Python)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Hardened Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Static Analysis & WAL Capability Verification
        run: |
          # Logic: Provably verifies WAL support via temporary filesystem anchor
          python - <<EOF
          import sqlite3
          import tempfile
          import os

          try:
              # Create a temporary file to test real-world WAL support
              fd, path = tempfile.mkstemp()
              os.close(fd)

              db = sqlite3.connect(path)
              cursor = db.execute("PRAGMA journal_mode=WAL")
              mode = cursor.fetchone()[0]
              
              db.close()
              os.remove(path)

              if mode.lower() != "wal":
                  raise ValueError(f"Sovereign Vault Integrity Failure: WAL not supported (got {mode})")
              
              print(f"ðŸ›ï¸ WAL Capability Verified: {mode.upper()}")
              
              # Safe Import Check (Assumes __name__ == "__main__" guards are present)
              import backend.main
              print("ðŸ§  Brain Import Verified")
              
          except Exception as e:
              print(f"âŒ Brain Critical Failure: {e}")
              exit(1)
          EOF

  body_integrity:
    name: Build Nexus Body (Flutter Web)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter (Synchronized 3.38.6)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          channel: 'stable'
          cache: true

      - name: Install Body Dependencies
        run: |
          cd client
          flutter pub get

      - name: Hardened Static Analysis
        run: |
          cd client
          # FAIL-CLOSED: Info-level violations trigger build termination
          flutter analyze --fatal-infos --fatal-warnings

      - name: Build Web Surface (Production Stress Test)
        run: |
          cd client
          # --no-tree-shake-icons: Hardening for custom typography in Phase 1.4.0
          flutter build web --release --no-tree-shake-icons